<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alphaMAK3R - alphaT00LS</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #2a2a2a;
            color: #ffffff;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .sidebar {
            width: 250px;
            background-color: #1e1e1e;
            padding: 20px;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        .sidebar.hidden {
            transform: translateX(-250px);
        }
        .sidebar .logo-image {
            width: 100%;
            transform: scaleX(-1);
            margin-bottom: 20px;
            display: block;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            color: #b85b1c;
            text-align: center;
        }
        .sidebar ul {
            list-style: none;
        }
        .sidebar ul li {
            margin: 20px 0;
            display: flex;
            align-items: center;
        }
        .sidebar ul li img {
            display: none;
        }
        .sidebar ul li a {
            color: #ffffff;
            text-decoration: none;
            font-size: 18px;
            transition: color 0.2s;
        }
        .sidebar ul li a:hover {
            color: #b85b1c;
        }
        .sidebar ul li a[href="/alphaMAK3R.html"] {
            font-size: 20px;
            font-weight: bold;
        }
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            width: 80%;
            box-sizing: border-box;
            margin-top: 96px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .header .image-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }
        .header img {
            max-width: 240px;
            height: auto;
        }
        .header .title-container {
            text-align: center;
            flex-grow: 1;
            padding: 0 20px;
            white-space: normal;
        }
        .header .title {
            font-size: 28px;
            margin: 0;
        }
        .header .subtitle {
            font-size: 12px; /* Smaller font as requested */
            margin: 0;
        }
        .section {
            margin-bottom: 20px;
        }
        .section h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .section .medium-text {
            font-size: 16px; /* Slightly bigger font for Additional Holders */
            margin-bottom: 5px;
        }
        .section .small-text {
            font-size: 12px; /* Smaller font for descriptions */
            margin-bottom: 10px;
        }
        .section input, .section select, .section button {
            padding: 5px;
            margin-right: 10px;
        }
        .section .status {
            margin-top: 10px;
            color: #ffcc00;
        }
        .wallet-connect {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        .wallet-connect img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            transition: transform 0.2s;
        }
        .wallet-connect img:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        .wallet-connect button {
            background-color: #b85b1c;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .wallet-connect button:hover {
            background-color: #a34f19;
        }
        .wallet-status {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #1e1e1e;
            border-radius: 5px;
        }
        .contact-links {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }
        .contact-links a img {
            width: 52px;
            height: 52px;
            transition: transform 0.2s;
        }
        .contact-links a img:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #b85b1c;
            color: #ffffff;
            border: none;
            padding: 10px;
            cursor: pointer;
            z-index: 1000;
        }
        .menu-toggle:hover {
            background-color: #a34f19;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .menu-toggle {
                display: block;
            }
        }
    </style>
</head>
<body>
    <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>
    <div class="wallet-connect">
        <img src="/images/settings.png" alt="Settings" onload="console.log('Loaded: settings.png')" onerror="console.log('Failed to load settings.png')">
        <button onclick="connectWallet()">Connect Wallet</button>
        <div id="wallet-status" class="wallet-status"></div>
    </div>
    <div class="sidebar" id="sidebar">
        <img src="/images/alphaAI.png" alt="Mirrored AlphaAI Logo" class="logo-image" onload="console.log('Loaded: alphaAI.png')" onerror="console.log('Failed to load alphaAI.png')">
        <div class="logo">alphaT00LS</div>
        <ul>
            <li><a href="/index.html">Home</a></li>
            <li><a href="/askalphaai.html">Ask AlphaAI</a></li>
            <li><a href="/alphaMAK3R.html">alphaMAK3R</a></li>
            <li><a href="/pumpfun-toolkit.html">Pump.FUN Tool-Kit</a></li>
            <li><a href="/chainmail.html">ChainMail</a></li>
            <li><a href="/alpharaider.html">alphaRAIDER</a></li>
            <li><a href="/alphatunes.html">alphaTUNES</a></li>
            <li><a href="/whale-enforcer.html">Whale Enforcer</a></li>
            <li><a href="/news.html">News</a></li>
            <li><a href="/roadmap.html">Roadmap</a></li>
            <li><a href="/aboutus.html">About Us</a></li>
        </ul>
    </div>
    <div class="main-content">
        <div class="header">
            <div class="image-row">
                <img src="/images/bunnyAlpha.png" alt="Bunny Alpha" onload="console.log('Loaded: bunnyAlpha.png')" onerror="console.log('Failed to load bunnyAlpha.png')">
                <div class="title-container">
                    <div class="title">alphaMAK3R</div>
                    <div class="subtitle">The best Volume Bot & Market Maker for Pump.fun / Solana there is!!</div>
                    <div class="small-text">
                        alphaMAK3R will use only warm wallets with trading history to buy into your token to generate large amounts of volume. Please adjust your settings below and we can get ready to start this up. Remember you can pause, cancel, adjust or recover your funds at anytime.
                    </div>
                </div>
                <img src="/images/babyalpha.png" alt="Baby Alpha" onload="console.log('Loaded: babyalpha.png')" onerror="console.log('Failed to load babyalpha.png')">
            </div>
        </div>
        <div class="section">
            <h2>Settings</h2>
            <div>
                <label>Token CA: 
                    <input type="text" id="tokenCA" placeholder="Enter Token CA" oninput="updateTokenInfo()">
                </label>
                <div id="tokenInfo" class="small-text"></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <label>Makers/Loops: <input type="number" id="numMakers" min="1" value="1" oninput="updateSettings()"></label>
                <label>Buy Amount (SOL): <input type="number" id="buyAmount" step="0.001" value="0.05" oninput="updateSettings()"></label>
                <label>Buy Cycle Min (s): <input type="number" id="buyCycleMin" min="5" value="30" oninput="updateSettings()"></label>
                <label>Max (s): <input type="number" id="buyCycleMax" min="10" value="40" oninput="updateSettings()"></label>
            </div>
        </div>
        <div class="section">
            <h2 class="medium-text">Additional Holders</h2>
            <div class="small-text">
                If selected the market maker will add several additional holders into your token while running the volume bot. This will greatly improve your tokens hype showing not only large amounts of volume but increasing holders as well.
            </div>
            <label>Enable Extra Holders? 
                <input type="checkbox" id="enableHolders" onchange="toggleHolderFields()">
            </label>
            <div id="holderFields" style="display: none;">
                <div>
                    <label># Additional Holders: <input type="number" id="numHolders" min="1" value="0" oninput="updateSettings()"></label>
                    <label>Holder Funding Amount (SOL): <input type="number" id="holderFundingAmount" step="0.001" value="0" oninput="updateSettings()" disabled></label>
                </div>
                <div class="small-text">Holder Buy-In Strategy - There are a number of ways your holders can buy in, each method has its own benefits, which would you like to use?</div>
                <div>
                    <label><input type="checkbox" name="buyStrategy" value="organic"> 1. Organic Buy-In</label>
                    <span class="small-text">This will buy in your holders at random intervals to appear most organic, increasing in speed as the token market cap increases.</span>
                </div>
                <div>
                    <label><input type="checkbox" name="buyStrategy" value="rapid"> 2. Rapid Buy-In</label>
                    <span class="small-text">This will buy in your holders very quickly to generate a spike in volume on your chart and grab your holder position early on.</span>
                </div>
                <div>
                    <label><input type="checkbox" name="buyStrategy" value="smart"> 3. Smart Buy-In</label>
                    <span class="small-text">Any time there is a sale on the chart not coming from the alphaMAK3R volume tool then another maker or two will buy into the chart, this both looks organic and assures your buyers are only buying on red candles.</span>
                </div>
            </div>
            <button onclick="saveSettings()">Save</button>
            <button onclick="clearSettings()">Clear</button>
            <div id="summary" class="small-text" style="display: none;"></div>
        </div>
        <div class="section">
            <h2>Funds</h2>
            <button onclick="window.location.href='/funds.html'">Funds</button>
            <div id="fundsStatus" class="status"></div>
        </div>
        <div class="section">
            <button id="startButton" onclick="startMarketMaker()">Start</button>
            <button id="stopButton" onclick="stopMarketMaker()" disabled>Stop</button>
            <div id="marketStatus" class="status"></div>
        </div>
        <div class="section">
            <button onclick="askAlphaAI()">Ask AlphaAI</button>
            <div id="alphaAIResponse" class="status"></div>
        </div>
        <div class="section">
            <button onclick="window.location.href='/operator-panel.html'">Operator Panel</button>
            <div id="operatorStatus" class="status"></div>
        </div>
    </div>
    <div class="contact-links">
        <a href="https://x.com/alphat00ls" target="_blank"><img src="/images/x.webp" alt="X" onload="console.log('Loaded: x.webp')" onerror="console.log('Failed to load x.webp')"></a>
        <a href="https://t.me/alphat00ls" target="_blank"><img src="/images/telegram.png" alt="Telegram" onload="console.log('Loaded: telegram.png')" onerror="console.log('Failed to load telegram.png')"></a>
        <a href="https://www.facebook.com/profile.php?id=61574135317387" target="_blank"><img src="/images/facebook.png" alt="Facebook" onload="console.log('Loaded: facebook.png')" onerror="console.log('Failed to load facebook.png')"></a>
    </div>

    <script>
        const API_URL = 'https://157.230.213.252/api';

        let settings = {
            tokenCA: null,
            tokenInfo: null,
            numMakers: 1,
            buyAmount: 0.05,
            buyCycleMin: 30,
            buyCycleMax: 40,
            keepMakersEnabled: false,
            keepMakersPercent: 0,
            isRunning: false,
            userFunds: {},
            makerLoops: [],
            fundedAmount: 0,
            connectedWallet: null,
            isVerified: false,
            numHolders: 0,
            holderFundingAmount: 0,
            buyStrategy: null
        };

        // Phantom Wallet Integration
        async function connectWallet() {
            if ("solana" in window) {
                const phantom = window.solana;
                try {
                    await phantom.connect();
                    settings.connectedWallet = phantom.publicKey.toString();
                    document.getElementById('wallet-status').style.display = 'block';
                    const tokenBalance = await checkTokenBalance(settings.connectedWallet);
                    settings.isVerified = tokenBalance >= 1000000;
                    document.getElementById('wallet-status').textContent = `Connected: ${settings.connectedWallet.slice(0, 6)}...${settings.connectedWallet.slice(-4)}${settings.isVerified ? ' (Verified)' : ' (Not Verified - Need 1,000,000 tokens)'}`;
                    console.log('Connected to Phantom wallet:', settings.connectedWallet, 'Token Balance:', tokenBalance);
                    updateSettings();
                } catch (error) {
                    document.getElementById('wallet-status').style.display = 'block';
                    document.getElementById('wallet-status').textContent = `Connection failed: ${error.message}`;
                    console.error('Phantom connection error:', error);
                }
            } else {
                document.getElementById('wallet-status').style.display = 'block';
                document.getElementById('wallet-status').textContent = 'Please install Phantom wallet extension.';
                alert('Please install the Phantom wallet extension to connect.');
            }
        }

        async function checkTokenBalance(walletAddress) {
            const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
            try {
                const tokenAccounts = await connection.getTokenAccountsByOwner(new solanaWeb3.PublicKey(walletAddress), { mint: new solanaWeb3.PublicKey(settings.tokenCA || 'YourTokenAddressHere') });
                if (!tokenAccounts.value.length) return 0;
                const balance = await connection.getTokenAccountBalance(tokenAccounts.value[0].pubkey);
                return balance.value.uiAmount || 0;
            } catch (error) {
                console.error(`Token balance check failed: ${error.message}`);
                return 0;
            }
        }

        async function sendTransaction(transaction, signers) {
            const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
            try {
                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.sign(...signers);
                const signedTransaction = await window.solana.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signedTransaction.serialize());
                await connection.confirmTransaction(signature);
                return { success: true, signature };
            } catch (error) {
                console.error(`Transaction failed: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        async function updateTokenInfo() {
            const tokenCA = document.getElementById('tokenCA').value;
            if (tokenCA) {
                settings.tokenCA = tokenCA;
                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenCA}`);
                const data = await response.json();
                const pair = data.pairs?.[0] || {};
                settings.tokenInfo = {
                    name: pair.baseToken?.name || 'Unknown Token',
                    symbol: pair.baseToken?.symbol || 'UNKNOWN',
                    price: pair.priceUsd ? `$${parseFloat(pair.priceUsd).toFixed(6)}` : 'N/A',
                    marketCap: pair.marketCap ? `$${parseFloat(pair.marketCap).toFixed(2)}` : 'N/A',
                    image: pair.baseToken?.logoURL || '/images/default-token.png'
                };
                document.getElementById('tokenInfo').innerHTML = `
                    <span>${settings.tokenInfo.name} (${settings.tokenInfo.symbol})</span>
                    <br><a href="https://app.axiom.io/explore/${tokenCA}" target="_blank">View on Axiom</a>
                    <br>Price: ${settings.tokenInfo.price} | Market Cap: ${settings.tokenInfo.marketCap}
                    <img src="${settings.tokenInfo.image}" alt="Token Image" style="max-width: 50px;">
                `;
            } else {
                document.getElementById('tokenInfo').innerHTML = '';
            }
            updateSettings();
        }

        function toggleHolderFields() {
            const enable = document.getElementById('enableHolders').checked;
            const holderFields = document.getElementById('holderFields');
            holderFields.style.display = enable ? 'block' : 'none';
            document.getElementById('numHolders').disabled = !enable;
            document.getElementById('holderFundingAmount').disabled = !enable;
            if (!enable) {
                settings.numHolders = 0;
                settings.holderFundingAmount = 0;
                settings.buyStrategy = null;
                document.getElementById('numHolders').value = 0;
                document.getElementById('holderFundingAmount').value = 0;
                document.querySelectorAll('input[name="buyStrategy"]').forEach(cb => cb.checked = false);
            }
            updateSettings();
        }

        function updateSettings() {
            settings.numMakers = parseInt(document.getElementById('numMakers').value) || 1;
            settings.buyAmount = parseFloat(document.getElementById('buyAmount').value) || 0.05;
            settings.buyCycleMin = parseInt(document.getElementById('buyCycleMin').value) || 30;
            settings.buyCycleMax = parseInt(document.getElementById('buyCycleMax').value) || 40;
            settings.numHolders = parseInt(document.getElementById('numHolders').value) || 0;
            settings.holderFundingAmount = parseFloat(document.getElementById('holderFundingAmount').value) || 0;
            settings.buyStrategy = document.querySelector('input[name="buyStrategy"]:checked')?.value || null;
            localStorage.setItem('alphaMAK3RSettings', JSON.stringify(settings));
            updateSummary();
        }

        function clearSettings() {
            settings = {
                tokenCA: null,
                tokenInfo: null,
                numMakers: 1,
                buyAmount: 0.05,
                buyCycleMin: 30,
                buyCycleMax: 40,
                keepMakersEnabled: false,
                keepMakersPercent: 0,
                isRunning: false,
                userFunds: {},
                makerLoops: [],
                fundedAmount: 0,
                connectedWallet: null,
                isVerified: false,
                numHolders: 0,
                holderFundingAmount: 0,
                buyStrategy: null
            };
            document.getElementById('tokenCA').value = '';
            document.getElementById('numMakers').value = 1;
            document.getElementById('buyAmount').value = 0.05;
            document.getElementById('buyCycleMin').value = 30;
            document.getElementById('buyCycleMax').value = 40;
            document.getElementById('enableHolders').checked = false;
            document.getElementById('numHolders').value = 0;
            document.getElementById('holderFundingAmount').value = 0;
            document.getElementById('holderFundingAmount').disabled = true;
            document.getElementById('numHolders').disabled = true;
            document.querySelectorAll('input[name="buyStrategy"]').forEach(cb => cb.checked = false);
            document.getElementById('tokenInfo').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            localStorage.setItem('alphaMAK3RSettings', JSON.stringify(settings));
        }

        function updateSummary() {
            if (settings.tokenCA && settings.tokenInfo) {
                const totalHolders = settings.numHolders;
                const holderPercentage = totalHolders > 0 ? (settings.holderFundingAmount * totalHolders / 100) : 0; // Simplified percentage
                const expectedVolume = settings.buyAmount * settings.numMakers * 100; // Estimated volume
                document.getElementById('summary').innerHTML = `
                    <strong>Summary:</strong><br>
                    Token: ${settings.tokenInfo.name} (${settings.tokenInfo.symbol})<br>
                    <img src="${settings.tokenInfo.image}" alt="Token Image" style="max-width: 50px;"><br>
                    Price: ${settings.tokenInfo.price} | Market Cap: ${settings.tokenInfo.marketCap}<br>
                    Settings: ${settings.numMakers} Makers, Buy Amount: ${settings.buyAmount} SOL, Cycle: ${settings.buyCycleMin}-${settings.buyCycleMax}s<br>
                    ${totalHolders > 0 ? `Holders: ${totalHolders}, Funding: ${settings.holderFundingAmount} SOL each, Strategy: ${settings.buyStrategy || 'None'}` : 'No additional holders'}<br>
                    Expected Volume: ~${expectedVolume.toFixed(2)} SOL<br>
                    Holder Percentage: ${holderPercentage.toFixed(2)}%
                `;
                document.getElementById('summary').style.display = 'block';
            } else {
                document.getElementById('summary').style.display = 'none';
            }
        }

        async function saveSettings() {
            if (!settings.isVerified) {
                alert('Wallet not verified! Connect a wallet with sufficient tokens.');
                return;
            }
            const response = await fetch(`${API_URL}/save-settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            const data = await response.json();
            document.getElementById('marketStatus').textContent = data.message || 'Settings saved!';
            setTimeout(() => document.getElementById('marketStatus').textContent = '', 2000);
            if (settings.numHolders > 0) {
                await generateHolderWallets();
            }
        }

        async function generateHolderWallets() {
            const totalWallets = settings.numHolders * 3; // 3 hops: 1 original + 2 intermediate
            const wallets = [];
            for (let i = 0; i < totalWallets; i++) {
                const { publicKey, secretKey } = solanaWeb3.Keypair.generate();
                wallets.push({ publicKey: publicKey.toBase58(), secretKey: Buffer.from(secretKey).toString('base64') });
            }
            // Distribute funding amount with Â±25% variation
            const baseAmount = settings.holderFundingAmount;
            const minAmount = baseAmount * 0.75;
            const maxAmount = baseAmount * 1.25;
            const fundedWallets = wallets.slice(-settings.numHolders).map((w, i) => ({
                ...w,
                amount: Math.random() * (maxAmount - minAmount) + minAmount
            }));
            const hopWallets = {
                userId: settings.connectedWallet || 'unknown',
                timestamp: Date.now(),
                wallets: wallets
            };
            const logPath = `./logs/${settings.connectedWallet}.${Date.now()}.hopwallets.json`;
            await fetch(`${API_URL}/save-wallets`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: logPath, data: hopWallets })
            });
            settings.makerLoops = fundedWallets.map(w => ({ publicKey: w.publicKey, secretKey: w.secretKey, isFunded: false }));
            localStorage.setItem('alphaMAK3RSettings', JSON.stringify(settings));
        }

        async function fundWallets() {
            if (!settings.isVerified) {
                document.getElementById('fundsStatus').textContent = 'Wallet not verified! Connect a wallet with sufficient tokens.';
                return;
            }
            const minRequiredAmount = (settings.numMakers * settings.buyAmount * 1.5) + (settings.numHolders * settings.holderFundingAmount) + 0.12;
            document.getElementById('fundsStatus').textContent = `Requesting approval to transfer ${minRequiredAmount.toFixed(4)} SOL for ${settings.numMakers} makers and ${settings.numHolders} holders.`;
            const { SystemProgram, Transaction, LAMPORTS_PER_SOL } = solanaWeb3;
            const fromWallet = window.solana.publicKey;
            const transactions = [];

            // Generate 3x wallets for 2 hops
            const totalWallets = settings.numHolders * 3;
            const allWallets = [];
            for (let i = 0; i < totalWallets; i++) {
                const { publicKey, secretKey } = solanaWeb3.Keypair.generate();
                allWallets.push({ publicKey: publicKey.toBase58(), secretKey: Buffer.from(secretKey).toString('base64') });
            }
            const hop1Wallets = allWallets.slice(0, settings.numHolders);
            const hop2Wallets = allWallets.slice(settings.numHolders, settings.numHolders * 2);
            const finalWallets = allWallets.slice(settings.numHolders * 2);

            // Distribute funding with Â±25% variation
            const baseHolderAmount = settings.holderFundingAmount;
            const minHolderAmount = baseHolderAmount * 0.75;
            const maxHolderAmount = baseHolderAmount * 1.25;
            const holderAmounts = finalWallets.map(() => Math.random() * (maxHolderAmount - minHolderAmount) + minHolderAmount);

            // Create transactions for 2 hops
            for (let i = 0; i < settings.numHolders; i++) {
                const amount = holderAmounts[i];
                transactions.push(new Transaction().add(SystemProgram.transfer({
                    fromPubkey: fromWallet,
                    toPubkey: new solanaWeb3.PublicKey(hop1Wallets[i].publicKey),
                    lamports: Math.floor(amount * LAMPORTS_PER_SOL)
                })));
                transactions.push(new Transaction().add(SystemProgram.transfer({
                    fromPubkey: new solanaWeb3.PublicKey(hop1Wallets[i].publicKey),
                    toPubkey: new solanaWeb3.PublicKey(hop2Wallets[i].publicKey),
                    lamports: Math.floor(amount * LAMPORTS_PER_SOL)
                })));
                transactions.push(new Transaction().add(SystemProgram.transfer({
                    fromPubkey: new solanaWeb3.PublicKey(hop2Wallets[i].publicKey),
                    toPubkey: new solanaWeb3.PublicKey(finalWallets[i].publicKey),
                    lamports: Math.floor(amount * LAMPORTS_PER_SOL)
                })));
            }

            // Execute transactions
            for (const tx of transactions) {
                const keypair = solanaWeb3.Keypair.generate(); // Placeholder, backend should sign
                const result = await sendTransaction(tx, [keypair]); // Backend should handle signing
                if (!result.success) {
                    document.getElementById('fundsStatus').textContent = `Transaction failed: ${result.error}`;
                    return;
                }
            }

            // Update settings with final wallets
            settings.makerLoops = finalWallets.map(w => ({ publicKey: w.publicKey, secretKey: w.secretKey, isFunded: true }));
            await fetch(`${API_URL}/update-settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            document.getElementById('fundsStatus').textContent = 'Wallets funded and holders set up!';
            localStorage.setItem('alphaMAK3RSettings', JSON.stringify(settings));
        }

        async function viewFunds() {
            if (!settings.isVerified) {
                document.getElementById('fundsStatus').textContent = 'Wallet not verified! Connect a wallet with sufficient tokens.';
                return;
            }
            const response = await fetch(`${API_URL}/view-funds?wallet=${settings.connectedWallet}`);
            const data = await response.json();
            document.getElementById('fundsStatus').textContent = data.message || 'No wallets with recoverable funds.';
        }

        async function recoverFunds() {
            if (!settings.isVerified) {
                document.getElementById('fundsStatus').textContent = 'Wallet not verified! Connect a wallet with sufficient tokens.';
                return;
            }
            const walletAddress = settings.connectedWallet;
            document.getElementById('fundsStatus').textContent = `Requesting approval to recover funds to ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}.`;
            const response = await fetch(`${API_URL}/recover-funds`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ walletAddress })
            });
            const data = await response.json();
            document.getElementById('fundsStatus').textContent = data.message || 'Recovery failed.';
        }

        async function startMarketMaker() {
            if (!settings.isVerified) {
                document.getElementById('marketStatus').textContent = 'Wallet not verified! Connect a wallet with sufficient tokens.';
                return;
            }
            if (!settings.tokenCA || !settings.numMakers || !settings.buyAmount || !settings.buyCycleMin || !settings.buyCycleMax) {
                document.getElementById('marketStatus').textContent = 'Please set all settings first!';
                return;
            }
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            settings.isRunning = true;
            localStorage.setItem('alphaMAK3RSettings', JSON.stringify(settings));
            document.getElementById('marketStatus').textContent = 'Market maker started!';
            runMarketMakerCycle(); // Keep existing cycle intact
        }

        async function stopMarketMaker() {
            if (!settings.isVerified) {
                document.getElementById('marketStatus').textContent = 'Wallet not verified! Connect a wallet with sufficient tokens.';
                return;
            }
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            settings.isRunning = false;
            localStorage.setItem('alphaMAK3RSettings', JSON.stringify(settings));
            document.getElementById('marketStatus').textContent = 'Market maker stopped!';
        }

        async function runMarketMakerCycle() {
            while (settings.isRunning) {
                for (let loopIndex = 0; loopIndex < settings.makerLoops.length; loopIndex++) {
                    const walletList = settings.makerLoops[loopIndex];
                    let walletIndex = 0;
                    while (settings.isRunning && walletList[walletIndex].isFunded) {
                        const wallet = walletList[walletIndex];
                        const keypair = solanaWeb3.Keypair.fromSecretKey(Buffer.from(wallet.secretKey, 'base64'));
                        const solBalance = await checkSolBalance(keypair.publicKey);
                        if (solBalance > settings.buyAmount + 0.005) {
                            const transaction = new solanaWeb3.Transaction().add(
                                solanaWeb3.SystemProgram.transfer({
                                    fromPubkey: keypair.publicKey,
                                    toPubkey: new solanaWeb3.PublicKey(settings.tokenCA),
                                    lamports: Math.floor(settings.buyAmount * LAMPORTS_PER_SOL)
                                })
                            );
                            const result = await sendTransaction(transaction, [keypair]);
                            if (result.success) console.log(`Buy executed for ${settings.buyAmount} SOL`);
                        }
                        walletIndex = (walletIndex + 1) % walletList.length;
                        await delay(Math.random() * (settings.buyCycleMax - settings.buyCycleMin) + settings.buyCycleMin * 1000);
                    }
                }
            }
        }

        async function checkSolBalance(walletAddress) {
            const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com', 'confirmed');
            try {
                const balance = await connection.getBalance(new solanaWeb3.PublicKey(walletAddress));
                return balance / LAMPORTS_PER_SOL;
            } catch (error) {
                console.error(`Sol balance check failed: ${error.message}`);
                return 0;
            }
        }

        async function askAlphaAI() {
            if (!settings.isVerified) {
                document.getElementById('alphaAIResponse').textContent = 'Wallet not verified! Connect a wallet with sufficient tokens.';
                return;
            }
            const question = prompt('Ask AlphaAI (e.g., "How much volume with 1 SOL?")');
            if (question) {
                const response = await fetch(`${API_URL}/alpha-ai`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, wallet: settings.connectedWallet })
                }).then(res => res.json()).then(data => data.response);
                document.getElementById('alphaAIResponse').textContent = response || 'No response from AlphaAI.';
            }
        }

        // Initialize settings from localStorage
        const savedSettings = localStorage.getItem('alphaMAK3RSettings');
        if (savedSettings) settings = JSON.parse(savedSettings);
        document.getElementById('tokenCA').value = settings.tokenCA || '';
        document.getElementById('numMakers').value = settings.numMakers;
        document.getElementById('buyAmount').value = settings.buyAmount;
        document.getElementById('buyCycleMin').value = settings.buyCycleMin;
        document.getElementById('buyCycleMax').value = settings.buyCycleMax;
        document.getElementById('enableHolders').checked = settings.numHolders > 0;
        document.getElementById('numHolders').value = settings.numHolders;
        document.getElementById('holderFundingAmount').value = settings.holderFundingAmount;
        document.getElementById('numHolders').disabled = !settings.numHolders;
        document.getElementById('holderFundingAmount').disabled = !settings.numHolders;
        document.querySelector(`input[name="buyStrategy"][value="${settings.buyStrategy}"]`)?.checked = true;
        document.getElementById('holderFields').style.display = settings.numHolders > 0 ? 'block' : 'none';
        updateTokenInfo();
        updateSettings();

        document.getElementById('enableHolders').addEventListener('change', toggleHolderFields);

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
        }
    </script>
